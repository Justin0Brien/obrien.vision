<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Interactive Hermann Grid (all controls working)</title>
<style>
  :root{
    --bg:#f5f5f7; --ink:#111; --panel:#fff; --accent:#2563eb; --accent-strong:#1d4ed8;
    --soft:#e5e7eb; --soft2:#d1d5db;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns: 560px 1fr; gap:16px; padding:16px; height:100%; box-sizing:border-box}
  .controls{background:var(--panel); border-radius:12px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.08); overflow:auto}
  fieldset{border:1px solid var(--soft); border-radius:10px; margin:0 0 14px; padding:10px 12px}
  legend{padding:0 6px; font-weight:650; color:#374151}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .hint{font-size:13px;color:#4b5563}
  canvas{width:100%;height:100%;display:block;background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .ctl{ display:grid; grid-template-columns: 1fr 280px 64px; gap:10px; align-items:center; margin:8px 0; }
  .ctl input[type="range"]{width:100%}
  .value{justify-self:end; min-width:64px; text-align:right; color:#111; font-variant-numeric: tabular-nums}
  .btn{ background:var(--soft); color:#111; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; }
  .btn:hover{background:var(--soft2)}
  .presets .btn.active{background:var(--accent); color:#fff; box-shadow: inset 0 0 0 2px rgba(255,255,255,.6)}
</style>
</head>
<body>
<div class="wrap">
  <div class="controls">
    <fieldset>
      <legend>Grid</legend>
      <div class="ctl"><span>Cells per row/column</span><input id="cells" type="range" min="3" max="20" value="8"><span id="cellsVal" class="value">8</span></div>
      <div class="ctl"><span>Square size (px)</span><input id="sq" type="range" min="18" max="120" value="64"><span id="sqVal" class="value">64</span></div>
      <div class="ctl"><span>Street width (px)</span><input id="street" type="range" min="6" max="40" value="22"><span id="streetVal" class="value">22</span></div>
      <div class="ctl"><span>Corner rounding (px)</span><input id="round" type="range" min="0" max="24" value="0"><span id="roundVal" class="value">0</span></div>
      <div class="ctl"><span>Square darkness</span><input id="dark" type="range" min="0" max="100" value="100"><span id="darkVal" class="value">100%</span></div>
      <div class="ctl"><span>Street brightness</span><input id="bright" type="range" min="0" max="100" value="100"><span id="brightVal" class="value">100%</span></div>
      <div class="ctl"><span>Grid contrast</span><input id="contrast" type="range" min="0" max="100" value="100"><span id="contrastVal" class="value">100%</span></div>
    </fieldset>

    <fieldset>
      <legend>Variants</legend>
      <div class="row presets">
        <button id="classic" class="btn">Classic</button>
        <button id="reverse" class="btn">Reverse contrast</button>
        <button id="scintillating" class="btn">Scintillating grid</button>
      </div>
      <div class="hint">Use reverse contrast or the scintillating grid to explore different variants. The illusion is strongest with straight bars and right-angle corners.</div>
    </fieldset>

    <fieldset>
      <legend>Export & reset</legend>
      <div class="row">
        <button id="exportPng" class="btn">Export PNG</button>
        <button id="reset" class="btn">Reset</button>
      </div>
    </fieldset>
  </div>

  <canvas id="cv" aria-label="Hermann Grid illusion canvas"></canvas>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const cv = $('cv');
  const ctx = cv.getContext('2d');

  const ctl = {
    cells:$('cells'), sq:$('sq'), street:$('street'), round:$('round'), dark:$('dark'), bright:$('bright'), contrast:$('contrast')
  };
  const val = {
    cells:$('cellsVal'), sq:$('sqVal'), street:$('streetVal'), round:$('roundVal'), dark:$('darkVal'), bright:$('brightVal'), contrast:$('contrastVal')
  };

  function fitCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const rect = cv.getBoundingClientRect();
    cv.width = Math.round(rect.width*dpr);
    cv.height = Math.round(rect.height*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function updateLabels(){
    val.cells.textContent = ctl.cells.value;
    val.sq.textContent = ctl.sq.value;
    val.street.textContent = ctl.street.value;
    val.round.textContent = ctl.round.value;
    val.dark.textContent = ctl.dark.value + '%';
    val.bright.textContent = ctl.bright.value + '%';
    val.contrast.textContent = ctl.contrast.value + '%';
  }

  function draw(){
    updateLabels();
    const W=cv.width, H=cv.height;
    ctx.clearRect(0,0,W,H);

    const n=+ctl.cells.value;
    const sz=+ctl.sq.value;
    const st=+ctl.street.value;
    const r=+ctl.round.value;
    const dark=+ctl.dark.value/100;
    const bright=+ctl.bright.value/100;
    const k=+ctl.contrast.value/100;

    // Derived colors
    const darkCol = Math.round(255*(1 - k*(1-dark)));
    const brightCol = Math.round(255*(k*bright));

    // Board size
    const boardW = n*sz + (n+1)*st;
    const boardH = boardW;
    const x0=(W-boardW)/2, y0=(H-boardH)/2;

    // Background (streets)
    ctx.fillStyle = `rgb(${brightCol},${brightCol},${brightCol})`;
    ctx.fillRect(x0,y0,boardW,boardH);

    // Squares
    ctx.fillStyle = `rgb(${darkCol},${darkCol},${darkCol})`;
    for(let rIdx=0;rIdx<n;rIdx++){
      for(let cIdx=0;cIdx<n;cIdx++){
        const x = x0 + st + cIdx*(sz+st);
        const y = y0 + st + rIdx*(sz+st);
        if (r>0){
          // rounded
          const rr = Math.min(r, sz/2);
          ctx.beginPath();
          ctx.moveTo(x+rr,y);
          ctx.arcTo(x+sz,y,x+sz,y+rr,rr);
          ctx.arcTo(x+sz,y+sz,x+sz-rr,y+sz,rr);
          ctx.arcTo(x,y+sz,x,y+sz-rr,rr);
          ctx.arcTo(x,y,x+rr,y,rr);
          ctx.closePath();
          ctx.fill();
        } else {
          ctx.fillRect(x,y,sz,sz);
        }
      }
    }
  }

  $('classic').addEventListener('click', ()=>{
    ctl.dark.value=100; ctl.bright.value=100; ctl.street.value=22; ctl.round.value=0; ctl.contrast.value=100; draw();
  });
  $('reverse').addEventListener('click', ()=>{
    ctl.dark.value=0; ctl.bright.value=0; ctl.contrast.value=100; draw();
  });
  $('scintillating').addEventListener('click', ()=>{
    ctl.street.value=18; ctl.round.value=0; ctl.contrast.value=100; draw();
  });

  $('exportPng').addEventListener('click', ()=>{
    const a=document.createElement('a');
    a.download='hermann-grid.png';
    a.href=cv.toDataURL('image/png');
    a.click();
  });

  document.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', draw, {passive:true}));

  function init(){
    fitCanvas();
    window.addEventListener('resize', fitCanvas, {passive:true});
    draw();
  }
  init();
})();
</script>
</body>
</html>
